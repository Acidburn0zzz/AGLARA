<?xml version="1.0" encoding="UTF-8"?>
<chapter version="5.0" xml:id="dnsserver"
         xmlns="http://docbook.org/ns/docbook"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:svg="http://www.w3.org/2000/svg"
         xmlns:m="http://www.w3.org/1998/Math/MathML"
         xmlns:html="http://www.w3.org/1999/xhtml"
         xmlns:db="http://docbook.org/ns/docbook">
  <title>DNS services</title>

  <section>
    <title>DNS</title>

    <para>So with the structure (and thus network/IP map) in place the first
    component up is DNS<indexterm>
        <primary>DNS</primary>
      </indexterm>.</para>

    <para>DNS, or <emphasis>Domain Name System</emphasis><indexterm>
        <primary>Domain Name System</primary>
      </indexterm>, allows resources on the network to be reachable through a
    human-readable name rather than an obscure ID that is useful for computers
    and routers. To support human-readable names, a DNS service is positioned
    which helps in translating these domain names onto IP addresses and vice
    versa. But next to the name resolving, DNS infrastructure is also
    positioned for various other purposes.</para>

    <figure>
      <title>DNS services</title>

      <mediaobject>
        <imageobject>
          <imagedata fileref="images/03-dnsservice.png" scalefit="0"
                     width="100%"/>
        </imageobject>
      </mediaobject>
    </figure>

    <para>For instance, a mail client can interact with the DNS server of a
    domain to find out where to send e-mails to that are meant for that
    domain. This information is stored in the MX records of that domain.
    Recently, standards are emerging to counter e-mail spoofing, like SPF
    (<emphasis>Sender Policy Framework</emphasis><indexterm>
        <primary>Sender Policy Framework</primary>
      </indexterm>) and DKIM<indexterm>
        <primary>DKIM</primary>
      </indexterm> (<emphasis>DomainKey Identified Mail</emphasis><indexterm>
        <primary>DomainKey Identified Mail</primary>
      </indexterm>). In case of SPF<indexterm>
        <primary>SPF</primary>
      </indexterm>, a DNS record tells whoever asks it which (IP) addresses
    are allowed to be sending e-mail that seems to originate from its domain.
    Mail servers will then check this record to see if an incoming e-mail
    indeed comes from this location and if not, can reject the e-mail. DKIM on
    the other hand uses digital signatures in the mail itself, where the mail
    servers then check the signature based on the public key that is stored in
    a DNS record of the domain that the mail seems to originate from.</para>

    <para>Another example of a service offered by DNS is documenting the SSH
    finger print of servers. SSH fingerprints are cryptographic hashes of the
    public key (and some additional information about it) used by the SSH
    service of a particular server. This fingerprint can then be added to the
    DNS server, and users that connect to an SSH server can verify if the
    fingerprint they receive is indeed the one expected to be from that
    server. If not, then they might be connecting to a malicious
    server.</para>

    <para>Having a well performing DNS architecture is extremely important as
    many services will rely on DNS to know how to contact other resources:
    although it is perfectly possible to use IP-only configurations, this is a
    lot less flexible and less transparent - and with IPv6 this will become
    even more difficult. Because of that, DNS must definitely be high
    available. Depending on the size and use, DNS caching daemons can be
    positioned across the network.</para>

    <figure>
      <title>Simple DNS architecture</title>

      <mediaobject>
        <imageobject>
          <imagedata fileref="images/03-dns-highlevel.png" scalefit="0"
                     width="100%"/>
        </imageobject>
      </mediaobject>
    </figure>

    <para>In the above architecture, two DNS servers are positioned (most
    likely in the DMZ) set up in a high-available manner (where a slave system
    pulls in changes from a master), and two internally with a similar setup.
    The distinction between the DMZ and the internal ones is that the internal
    DNS servers will host a lot more information needed for the internal
    components, whereas the ones on the DMZ only contain information for the
    publicly available services.</para>

    <para>In both cases (DMZ and internal), a configuration management
    database is responsible for providing the addresses and names.</para>
  </section>

  <section>
    <title>Architecture</title>

    <para>Many organizations will host their own domain name servers, and
    perhaps have a third one outside their premises as a fall-back. In this
    reference architecture, BIND is used as the DNS software of choice. Name
    servers such as BIND structure their contents in
    <emphasis>zones</emphasis><indexterm>
        <primary>zones</primary>
      </indexterm>. A zone is a set of IP addresses, hostnames and affiliated
    information, most often for one domain. So genfic.com is one domain (one
    zone) whereas internal.genfic.com is another domain (zone).</para>

    <section>
      <title>Flows and feeds</title>

      <para>Within the DNS server setup, the following flows are
      defined:</para>

      <itemizedlist>
        <listitem>
          <para>zone transfer flow</para>
        </listitem>

        <listitem>
          <para>zone configuration</para>
        </listitem>
      </itemizedlist>

      <figure>
        <title>Flows and feeds</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="images/03-bind-flow.png"/>
          </imageobject>
        </mediaobject>
      </figure>

      <section>
        <title>Zone transfer flow</title>

        <para>The zone transfers are to update the slave(s).</para>
      </section>

      <section>
        <title>Zone configuration</title>

        <para>Updates on the zones themselves are triggered through the
        configuration management service, where new (or to be deleted) zones
        are created and then uploaded towards the name server.</para>
      </section>
    </section>

    <section>
      <title>Administration</title>

      <para>Administration of the DNS server is done through the configuration
      management service (Puppet) and manual operations (SSH).</para>

      <figure>
        <title>BIND administration</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="images/03-bind-admin.png"/>
          </imageobject>
        </mediaobject>
      </figure>

      <para>The configuration for the server (and BIND) is first pulled from
      the configuration management repository (through a <command>git
      pull</command>, most likely scheduled or triggered by the administrator)
      after which the (re)configuration of BIND is done. This results in
      updates on the <filename>named.conf</filename><indexterm>
          <primary>named.conf</primary>
        </indexterm> file. The <command>rndc</command><indexterm>
          <primary>rndc</primary>
        </indexterm> command is used to interact with the
      <command>named</command> daemon itself.</para>
    </section>

    <section>
      <title>Monitoring</title>

      <para>The monitors for BIND should do at least the following
      checks:</para>

      <itemizedlist>
        <listitem>
          <para>See if the processes are running (and bound on a reachable
          interface)</para>
        </listitem>

        <listitem>
          <para>See if there are any errors mentioned in the logs</para>
        </listitem>

        <listitem>
          <para>See if the named server returns proper records (check on
          various types, DNSSEC info, etc.)</para>
        </listitem>

        <listitem>
          <para>See if the serial of the master and slave is the same</para>
        </listitem>
      </itemizedlist>

      <figure>
        <title>BIND monitoring</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="images/03-bind-monitoring.png"/>
          </imageobject>
        </mediaobject>
      </figure>

      <section>
        <title>Process running and bound to the right interface</title>

        <para>Checking if processes are running is a primitive check, but
        quite important to troubleshoot potential failures. The check should
        also include validation that the processes are bound on reachable
        interfaces - a named daemon that only runs on localhost is not
        reachable through the network.</para>
      </section>

      <section>
        <title>Errors in logs</title>

        <para>Validate that there are no errors in the logs, and assign proper
        procedures when certain, well-known errors occur.</para>
      </section>

      <section>
        <title>Record retrieval</title>

        <para>On a remote system, <command>dig</command> can be used to
        retrieve a set of records and validate that the return value is
        correct (and perhaps also within the time boundaries).</para>
      </section>

      <section>
        <title>Serial validation</title>

        <para>The serial (which is the version of the zone files) should be
        the same on the master and slave. If this is not the case, the monitor
        should check with the previous state (master and slave are allowed to
        be not synchronized for a very short while) and if that previous state
        was also showing differences in serial version, then an alert should
        be raised that the zone transfer between master and slave is most
        likely not working.</para>
      </section>
    </section>

    <section>
      <title>Operations</title>

      <para>When running, BIND is a fairly simple daemon from an architectural
      point of view.</para>

      <figure>
        <title>Standard operation usage of BIND</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="images/03-bind-operations.png" scalefit="0"
                       width="100%"/>
          </imageobject>
        </mediaobject>
      </figure>

      <para>Network-wise, it interacts with two other services: other BIND
      servers (for zone transfers) and with standard clients (for querying the
      DNS records).</para>

      <para>On the system, the interaction is mainly with the system logger
      (over a socket). The resources that the named daemon uses are its
      configuration (and cryptographic keys if applicable) and its zone
      files.</para>
    </section>

    <section>
      <title>Users</title>

      <para>DNS services are, by default, anonymous services. Some access
      controls are often placed to restrict who can (from a network point of
      view) query the DNS service or send/receive data from (in case of pull
      requests/zone transfers), and more tight access controls (like shared
      keys) can be used to further authenticate such activities. However, real
      "users" are not known in the BIND setup.</para>

      <para>That being said, the SELinux policy for BIND does provide an
      administrative interface, supporting the definition of roles that are
      allowed to administer a BIND environment without granting those users
      full administrative access on the system. The interface is called
      <interfacename>bind_admin</interfacename> and takes two arguments: the
      user domain allowed access and its role.</para>

      <programlisting>bind_admin(&lt;userdomain&gt;, &lt;userrole&gt;)</programlisting>
    </section>

    <section>
      <title>Security</title>

      <para>DNS services are widely available and are a high-profile target
      for hackers and malicious persons or organizations. If someone could
      change the DNS records for a domain, then it can have users visit
      different sites (which are made to look like the official site) which
      might allow the perpetrator to get access to authentication credentials,
      confidential information and more. He only needs to modify the IP
      address replies that the DNS server would give and have them point to
      its own website. This is called DNS hijacking, and does not only
      introduce the risk of "spoofed websites", but also changes in e-mail
      flows (for instance, the malicious user changes the MX records to point
      to his own e-mail server so he can watch and even modify e-mail
      communication to the official domain).</para>

      <para>To provide some level of protection against these threats, a
      number of security changes are recommended:</para>

      <itemizedlist>
        <listitem>
          <para>If the registrar supports DNSSEC<indexterm>
              <primary>DNSSEC</primary>
            </indexterm>, then enable DNSSEC on the zones as well. With
          DNSSEC, the resource records in the zone are digitally signed (by
          private keys) and that key is signed by the parent domain (hence the
          need for the registrar and higher-level domains to support it
          too).</para>

          <para>This provides some additional protection against DNS
          hijacking, although it is not perfect (end users must use DNSSEC for
          their lookups and should have a valid trusted keystore containing
          the root DNS server keys).</para>
        </listitem>

        <listitem>
          <para>Enable SPF (Sender Policy Framework) so that mail servers who
          receive an e-mail that is supposed to be sent by the official
          locations (or someone within the environment), then the mail server
          can check the origin address against the SPF records in the DNS to
          validate if they match or not.</para>
        </listitem>

        <listitem>
          <para>Enable DKIM (DomainKey Identified Mail) to sign outgoing
          e-mails and provide the DKIM public key in the DNS records so
          DKIM-supporting mail servers can validate the signatures.</para>
        </listitem>

        <listitem>
          <para>Enable DMARC (Domain-based Message Authentication, Reporting
          and Conformance) to receive reports on how mails from that domain
          are treated, as well as identify which protective measures the
          domain takes</para>
        </listitem>
      </itemizedlist>

      <section>
        <title>DNSSEC</title>

        <para>The DNSSEC structure adds in a number of DNS records that help
        with the authentication of the DNS data, as well as verification of
        the integrity of this data. This protects the DNS records from both
        hijacking as well as tampering.</para>

        <figure>
          <title>DNSSEC overview</title>

          <mediaobject>
            <imageobject>
              <imagedata fileref="images/04-dnssec.png"/>
            </imageobject>
          </mediaobject>
        </figure>

        <para>The idea is that a record (in the example the record for
        www.genfic.com) has its various types signed. In the example, two
        types are provided (A and AAAA), each of these has its own signature
        in an <emphasis>RRSIG<indexterm>
            <primary>RRSIG</primary>
          </indexterm><indexterm>
            <primary>Resource Record Signature</primary>
          </indexterm> (Resource Record Signature)</emphasis> field. The RRSIG
        fields are digital signatures made with a private key called the
        <emphasis>ZSK<indexterm>
            <primary>ZSK</primary>
          </indexterm><indexterm>
            <primary>Zone Signing Key</primary>
          </indexterm> (Zone Signing Key)</emphasis> of which the public key
        part is available in the zone, in a <emphasis>DNSKEY<indexterm>
            <primary>DNSKEY</primary>
          </indexterm> (DNS public Key)</emphasis> field. This field is also
        signed by a private key called the <emphasis>KSK<indexterm>
            <primary>KSK</primary>
          </indexterm><indexterm>
            <primary>Key Signing Key</primary>
          </indexterm> (Key Signing Key)</emphasis> also available in a DNSKEY
        field in the zone.</para>

        <para>Now, to verify that the KSK public key is the proper key, it is
        also signed with the KSK private key, but also by the zone signing key
        of the parent domain (in our example, the .com zone). This domain has
        a <emphasis>DS<indexterm>
            <primary>DS</primary>
          </indexterm><indexterm>
            <primary>Delegation Signer</primary>
          </indexterm> (Delegation Signer)</emphasis> field in the genfic.com
        zone record, which contains a hash of the genfic.com KSK public key
        (the field itself), and this hash is signed through the parent zone
        RRSIG field.</para>

        <para>In the drawing <emphasis>NSEC<indexterm>
            <primary>NSEC</primary>
          </indexterm><indexterm>
            <primary>Next Secure</primary>
          </indexterm> (Next Secure)</emphasis> fields are also shown. This
        "chains" multiple secure records with each other, providing a way for
        requestors to make sure a record really does not exist (upon retrieval
        of a nonexisting record, the DNS server replies with data pointing out
        that between records 1 and 2, there is no record for the requested
        one).</para>

        <para>Next to NSEC, it is also possible to use NSEC3. NSEC3 covers one
        of the possible security holes that NSEC provides: malicious people
        can "walk" across all the NSECs to get a view of the entire zone. For
        fully public zones, this is not an issue, but many DNS servers want
        only to expose a few of the records in a zone, and NSEC requires that
        all records are public. With <emphasis>NSEC3<indexterm>
            <primary>NSEC3</primary>
          </indexterm><indexterm>
            <primary>DNSSEC Hashed Authenticated Denial of Existence</primary>
          </indexterm> (DNSSEC Hashed Authenticated Denial of
        Existence)</emphasis> not the record name itself (like "www") but a
        hashed value of it is used. This prevents "walking" over the entire
        zone, while still providing validation that records do (or don't)
        exist.</para>
      </section>

      <section>
        <title>SPF - Sender Policy Framework</title>

        <para>In <emphasis>SMTP<indexterm>
            <primary>SMTP</primary>
          </indexterm><indexterm>
            <primary>Simple Mail Transfer Protocol</primary>
          </indexterm> (Simple Mail Transfer Protocol)</emphasis> mail clients
        need to pass on information about the mail they are sending. It starts
        with the HELO (or EHLO) statements, telling the mail server who the
        client system is, followed by information whom the mail is from (MAIL
        FROM) and to who the mail should be sent (RCPT TO):</para>

        <programlisting>220 mail.internal.genfic.com
&gt; <command>HELO relay.internal.genfic.com</command>
250 relay.internal.genfic.com Hello relay.internal.genfic.com [10.24.2.3], pleased to meet you
&gt; <command>MAIL FROM: &lt;someone@genfic.com&gt;</command>
250 someone@genfic.com... Sendor ok
&gt; <command>RCPT TO: &lt;otherone@genfic.com&gt;</command>
250 otherone@genfic.com... Recipient ok (will queue)
&gt; <command>DATA</command>
354 Enter mail, end with "." on a line by itself
...</programlisting>

        <para>A first check that mail servers (should) do is validate that the
        fully qualified hostname provided through the HELO (or EHLO) commands
        really comes from that host. If it doesn't, then it is possibly a fake
        mail. But other than that, there are little checks done to see if the
        mail is truly sent from and to those mail boxes.</para>

        <para>With SPF<indexterm>
            <primary>SPF</primary>
          </indexterm><indexterm>
            <primary>Sender Policy Framework</primary>
          </indexterm> mail servers will do one or two more checks:</para>

        <itemizedlist>
          <listitem>
            <para>the mail server will first check if the host (as provided by
            the HELO/EHLO) is allowed to send mails, and</para>
          </listitem>

          <listitem>
            <para>the mail server will then check if this host is allowed to
            send mail for the given domain (as provided by the MAIL
            FROM)</para>
          </listitem>
        </itemizedlist>

        <para>For this to happen, specific fields are added to the host
        record:</para>

        <programlisting>.genfic.com.  IN  SPF  "v=spf1 mx a -all"
.genfic.com.  MX  10   relay.internal.genfic.com

relay.internal.genfic.com   IN   SPF   "v=spf1  ip4:10.24.2.3 a -all"
relay.internal.genfic.com    A   10.24.2.3</programlisting>

        <para>The SPF records can be read as:</para>

        <itemizedlist>
          <listitem>
            <para>Mails sent for the genfic.com domain are allowed to be sent
            from any system that is defined as an MX record; all others are
            denied</para>
          </listitem>

          <listitem>
            <para>The relay.internal.genfic.com system is allowed to send mail
            (as long as it is really this system, with IP 10.24.2.3).</para>
          </listitem>
        </itemizedlist>
      </section>

      <section>
        <title>DKIM</title>

        <para>DKIM (DomainKeys Identified Mail) uses cryptographic signatures
        on the e-mail (and important headers of the e-mail) to provide
        authenticity on the mail. Mail servers that use DKIM will sign the
        outgoing e-mails with a private key (whose public component can be
        obtained through DNS, on the
        <code>&lt;hostname&gt;._domainkey.&lt;domain&gt;</code> TXT record).
        Receiving mail servers can then validate that the mail they receive,
        if it has a DKIM signature, has not been tampered with along the
        way.</para>

        <para>A mail can have DKIM signatures of non-authorative domains
        though (domains that are not related to the mail). An extension on
        DKIM, called <emphasis>ADSP<indexterm>
            <primary>ADSP</primary>
          </indexterm><indexterm>
            <primary>Author Domain Signing Practices</primary>
          </indexterm> (Author Domain Signing Practices)</emphasis> provides a
        signature that is authenticated through the same domain as the mail
        says it is from. If ADSP is used, then an additional TXT record exists
        that informs recipients of this. Recipients should check this field to
        see if they should find a proper DKIM signature (from that domain) or
        not.</para>

        <para>This TXT record is for
        <code>_adsp._domainkey.&lt;domain&gt;</code>.</para>
      </section>

      <section>
        <title>DMARC</title>

        <para><emphasis>DMARC<indexterm>
            <primary>DMARC</primary>
          </indexterm> (Domain-based Message Authentication, Reporting and
        Conformance)</emphasis> is used to inform other systems how to treat
        non-conformance (if mails are not according to the SPF requests, or
        DKIM signatures are missing, or...). This information is available
        through the <code>_dmarc.&lt;domain&gt;</code> record and uses tags
        (similar to SPF).</para>

        <programlisting>.genfic.com    TXT    "v=DMARC1 p=quarantine pct=20 rua=mailto:dmarc@genfic.com sp=r aspf=r"</programlisting>

        <para>The above record tells other parties that:</para>

        <itemizedlist>
          <listitem>
            <para>If mails fail the DKIM/SPF checks (generally called the
            DMARC checks), then 20% of those mails should be quarantined.
            Daily reports are sent to dmarc@genfic.com</para>
          </listitem>

          <listitem>
            <para>The policy for subdomains (sp) is relaxed</para>
          </listitem>

          <listitem>
            <para>The alignment mode for SPF (aspf) is related</para>
          </listitem>
        </itemizedlist>
      </section>
    </section>
  </section>

  <section>
    <title>BIND</title>

    <para>On the Internet, Berkeleys Internet Name Domain (BIND) server is the
    most popular DNS server to date. It has been plagued by its set of
    security issues, but is still very well supported on Gentoo (and other)
    platforms. The software was originally developed at Berkeley in the early
    80s in an open source model. Since 2010, the software is maintained by the
    Internet Systems Consortium.</para>

    <para>Because it has such a large history, it has also seen quite a few
    updates and even rewrites. The current major version (BIND 9) is a rewrite
    that was tailored to answer the various secrity-related concerns that came
    from earlier versions. Sadly, even BIND 9 has seen its set of security
    vulnerabilities. Although a new major is in the making (BIND 10) it is not
    made generally available for production use yet.</para>

    <section>
      <title>From records to views</title>

      <para>For DNS, the smallest set of information it returns is called a
      record. Records are grouped together in domains, and domains are grouped
      in zones. Within a record, there are 6 fields (including the name of the
      record and the type). In the next few sections, the syntax as used by
      BIND is described although the concepts are the same for other DNS
      servers.</para>

      <section>
        <title>Record structure</title>

        <para>When an IP address for a host name is declared, this actually
        maps on a DNS record:</para>

        <programlisting>www    IN  A      192.168.0.2</programlisting>

        <para>This record states that, within the domain that this record is a
        part of, that 'www.&lt;domain&gt;' resolves to 192.168.0.2. Type type
        of the record here is A. An IPv6 address would result in a AAAA
        record.</para>

        <programlisting>mail   IN  AAAA  2001:db8:10::1</programlisting>

        <para>For the same host, there can be multiple records as long as they
        are of a different type (and don't make the definitions
        ambiguous).</para>

        <programlisting>www    IN  A     192.168.0.2
       IN  AAAA  2001:db8:10::1</programlisting>

        <para>There are many record types available (and more are being
        defined every few years). For instance:</para>

        <itemizedlist>
          <listitem>
            <para>CNAME which says that the given host name is an alias for
            another record</para>
          </listitem>

          <listitem>
            <para>LOC provides location information for servers</para>
          </listitem>

          <listitem>
            <para>SSHFP gives the SSH finger print information for a
            server</para>
          </listitem>
        </itemizedlist>

        <para>etc...</para>
      </section>

      <section>
        <title>Domains</title>

        <para>Multiple records are combined within a domain.</para>

        <programlisting>; Comments are prepended with a semi-colon
$TTL 24h ; If records do not hold TTL information themselves, use this as default
$ORIGIN internal.genfic.com.  ; Domain that is defined here
@  1D  IN  SOA ns1.internal.genfic.com. hostmaster.genfic.com. (
         2013020401 ; serial
         3H ; refresh
         15 ; retry
         1w ; expire
         3h ; minimum
       )
       IN  NS     ns1.internal.genfic.com. ; in the domain</programlisting>

        <para>In the above example, the @ sign is shorthand for the domain
        ($ORIGIN).</para>

        <para>The first record in the domain declaration is the SOA record,
        and after this record there is an NS record.</para>
      </section>

      <section>
        <title>Zone</title>

        <para>One (or more) domains (and their affiliated records) are stored
        in a zone file. A zone is a specific space within the global Domain
        Name System that is managed (administered) by a single authority.
        Other DNS servers might also serve the same zone, but they will not be
        marked as the authoritative DNS service for that zone.</para>
      </section>

      <section>
        <title>View</title>

        <para>A view is not DNS specific, but a feature that many DNS servers
        offer. A view uses <emphasis>different zone files</emphasis> depending
        on the requestor. For instance, a DNS server might serve both
        Internet-originating requests as well as internal requests.
        Internet-originating requests thus need to receive the Internet-facing
        IP addresses as replies, but internal requests can use internal IP
        addresses.</para>

        <programlisting>public-host$ <command>dig +short @ns1.genfic.com www.genfic.com A</command>
123.45.67.89
intern-host$ <command>dig +short @ns1.genfic.com www.genfic.com A</command>
10.152.20.12</programlisting>
      </section>
    </section>

    <section>
      <title>Deployment and uses</title>

      <para>Configuring BIND on Gentoo Linux is fairly similar as configuring
      BIND on other platforms. There are plenty of good and elaborate
      resources on BIND configuration on the Internet, some of which are
      mentioned at the end of this chapter.</para>

      <section>
        <title>Installing bind</title>

        <para>First, install net-dns/bind. An overview of the USE flags used
        here is shown as well as output of the equery command.</para>

        <programlisting># <command>equery u bind</command>
[ Legend : U - final flag setting for installation]
[        : I - package is installed with flag     ]
[ Colors : set, unset                             ]
 * Found these USE flags for net-dns/bind-9.9.2_p1:
 U I
 - - berkdb      : Adds support for sys-libs/db (Berkeley DB for MySQL)
 + + caps        : Use Linux capabilities library to control privilege
 + + dlz         : Enables dynamic loaded zones, 3rd party extension
 - - doc         : Adds extra documentation (API, Javadoc, etc). It is recommended \
                   to enable per package instead of globally
 - - filter-aaaa : Enable filtering of AAAA records over IPv4
 - - geoip       : Add geoip support for country and city lookup based on IPs
 - - gost        : Enables gost OpenSSL engine support
 - - gssapi      : Enable gssapi support
 - - idn         : Enable support for Internationalized Domain Names
 + + ipv6        : Adds support for IP version 6
 - - ldap        : Adds LDAP support (Lightweight Directory Access Protocol)
 - - mysql       : Adds mySQL Database support
 - - odbc        : Adds ODBC Support (Open DataBase Connectivity)
 - - postgres    : Adds support for the postgresql database
 - - python      : Adds optional support/bindings for the Python language
 - - rpz         : Enable response policy rewriting (rpz)
 - - rrl         : Response Rate Limiting (RRL) - Experimental
 - - sdb-ldap    : Enables ldap-sdb backend
 + + ssl         : Adds support for Secure Socket Layer connections
 - - static-libs : Build static libraries
 + + threads     : Adds threads support for various packages. Usually pthreads
 + + urandom     : Use /dev/urandom instead of /dev/random
 + + xml         : Add support for XML files

# <command>emerge net-dns/bind net-dns/bind-tools</command>
# <command>rc-update add named default</command></programlisting>
      </section>

      <section>
        <title>Initial configuration</title>

        <para>The configuration below is meant for a master DNS server.</para>

        <para>Start with <filename>/etc/bind/named.conf</filename><indexterm>
            <primary>named.conf</primary>
          </indexterm>:</para>

        <programlisting>options {
  directory "/var/bind";
  pid-file "/var/run/named/named.pid";
  statistics-file "/var/run/named/named.stats";
  listen-on { 127.0.0.1; };
  listen-on-v6 { 2001:db8:81:21::ac:98ad:5fe1; };
  allow-query { any; };
  zone-statistics yes;
  allow-transfer { 2001:db8:81:22::ae:6b01:e3d8; };
  notify yes;
  recursion no;
  version "[nope]";
};

# Access to DNS for local addresses (i.e. genfic-owned)
view "local" {
  match-clients { 2001:db8:81::/48; };
  recursion yes;
  zone "genfic.com" { 
    type master;
    file "pri/com.genfic";
  };
  zone "1.8.0.0.8.b.d.0.1.0.0.2.ip6.arpa" {
    type master;
    file "pri/1.8.0.0.8.b.d.0.1.0.0.2.ip6.arpa";
  };
};</programlisting>

        <para>That's it. The configuration will have this installation work as
        the master DNS server and will (only) accept DNS requests from IPv6
        addresses within the defined IP range. For these requests, the
        <filename>pri/com.genfic</filename> file is used (which is the "zone"
        file that will contain the DNS records) and
        <filename>pri/1.8.0.0.8.b.d.0.1.0.0.2.ip6.arpa</filename> for the
        reverse lookups.</para>

        <para>The name of the reverse lookup is fairly difficult to work with
        by people. For this reason, create a symbolic link that makes this a
        lot easier:</para>

        <programlisting># <command>ln -s 1.8.0.0.8.b.d.0.1.0.0.2.ip6.arpa genfic.com.inv</command></programlisting>

        <para>This way, &lt;domain&gt;.inv is a symbolic link pointing to the
        reverse lookup zone definition.</para>

        <para>For the slave server, the setup is fairly similar:</para>

        <itemizedlist>
          <listitem>
            <para>do not set the <parameter>allow-transfer</parameter> though.
            It is a slave server.</para>
          </listitem>

          <listitem>
            <para>set the type of the zone's to "<parameter>slave</parameter>"
            instead and add in <userinput>masters {
            2001:db8:81:21::ac:98ad:5fe1; }</userinput> to each zone. That
            will tell BIND what the master of this particular zone is.</para>
          </listitem>

          <listitem>
            <para>on the slave, set the
            <parameter>named_write_master_zones</parameter> SELinux boolean to
            "on" so that the <code>named_t</code> domain can write to the
            cache location.</para>
          </listitem>
        </itemizedlist>

        <para>Finally, set the initial zone files for the organization.</para>

        <programlisting># <command>cat /var/bind/pri/com.genfic</command>
$TTL 1h ;
$ORIGIN genfic.com.
@       IN      SOA     ns.genfic.com. ns.genfic.com. (
                        2012041101
                        1d      
                        2h
                        4w
                        1h )

        IN      NS      ns.genfic.com.
        IN      NS      ns2.genfic.com.
        IN      MX      10      mail.genfic.com.
        IN      MX      20      mail2.genfic.com.

genfic.com.     IN      AAAA    2001:db8:81:80::dd:13ed:c49e;
ns              IN      AAAA    2001:db8:81:21::ac:98ad:5fe1;
ns2             IN      AAAA    2001:db8:81:22::ae:6b01:e3d8;
www             IN      CNAME   genfic.com.;
mail            IN      AAAA    2001:db8:81:21::b0:0738:8ad5;
mail2           IN      AAAA    2001:db8:81:22::50:5e9f:e569;
; (...)</programlisting>

        <programlisting># <command>cat /var/bind/pri/com.genfic.inv</command>
$TTL 1h ;
@       IN      SOA     1.8.0.0.8.b.d.0.1.0.0.2.ip6.arpa ns.genfic.com. (
                        2012041101
                        1d
                        2h
                        4w
                        1h )

        IN      NS      ns.genfic.com.
        IN      NS      ns2.genfic.com.

$ORIGIN 1.8.0.0.8.b.d.0.1.0.0.2.ip6.arpa.

1.e.f.5.d.a.8.9.c.a.0.0.0.0.0.0.1.2.0.0         IN      PTR     ns.genfic.com.
8.d.3.e.1.0.b.6.e.a.0.0.0.0.0.0.2.2.0.0         IN      PTR     ns2.genfic.com.
; (...)</programlisting>

        <para>With the configuration done, start the named daemon.</para>

        <programlisting># <command>run_init rc-service named start</command></programlisting>
      </section>

      <section>
        <title>Hardening zone transfers</title>

        <para>The BIND system can get additional hardening by introducing
        transaction signatures (TSIG<indexterm>
            <primary>TSIG</primary>
          </indexterm>). To do so, create a shared secret (key) with
        <command>dnssec-keygen</command>. The generated key is then added to
        the <filename>named.conf</filename> file like so:</para>

        <programlisting># <command>dnssec-keygen -a HMAC-MD5 -b 128 -n HOST secundary</command>
# <command>cat Ksecundary.*.key</command>
secundary. IN KEY 512 3 157 d8fhe2frgY24WFedx348==</programlisting>

        <programlisting>(... In named.conf ...)
key secundary { algorithm hmac-md5; secret "d8fhe2frgY24WFedx348=="; };

(... In named.conf's zone definition ...)
allow-update { key secundary; };</programlisting>

        <para>In the slave's configuration, add in an entry for the master and
        refer to this key as well.</para>

        <programlisting>(... In named.conf ...)
key secundary { algorithm hmac-md5; secret "d8fhe2frgY24WFedx348=="; };
server 2001:db8:81:21::ac:98ad:5fe1 { keys { secundary; }; };</programlisting>

        <para>It is not possible to use the TSIG together with an IP address
        list though, so either use the keys or use IP addresses (or use the
        keys and define local firewall rules).</para>
      </section>

      <section>
        <title>Hardening DNS records (DNSSEC)</title>

        <para>To use DNSSEC, first create two keypairs. One is the KSK (Key
        Signing Key) and is a long-term keypair. It will be used to sign the
        ZSKs (Zone Signing Keys) used for the zones. ZSKs are used to sign
        most DNS records, whereas the KSK is used to sign the ZSK. It is also
        the KSK which is signed by the "higher-level" domain.</para>

        <programlisting># <command>cd /var/named/chroot/etc/bind</command>
# <command>mkdir keys &amp;&amp; cd keys</command>
# <command>dnssec-keygen -a RSASHA256 -b 2048 -3 genfic.com</command>
# <command>dnssec-keygen -a RSASHA256 -b 2048 -3 -fk genfic.com</command>
# <command>chown -R named:named .</command></programlisting>

        <para>Next, update the BIND configuration to use these keys. Below is
        an updated <filename>named.conf</filename> file with highlights where
        changes were made:</para>

        <programlisting>options {
  directory "/var/bind";
  pid-file "/var/run/named/named.pid";
  statistics-file "/var/run/named/named.stats";
  listen-on { 127.0.0.1; };
  listen-on-v6 { 2001:db8:81:21::ac:98ad:5fe1; };
  allow-query { any; };
  zone-statistics yes;
  allow-transfer { 2001:db8:81:22::ae:6b01:e3d8; };
  notify yes;
  recursion no;
  version "[nope]";
<command>  dnssec-validation yes;
  dnssec-lookaside auto;
  dnssec-enable yes;
  key-directory "/etc/bind/keys";
  allow-new-zones yes;</command>
};
view "local" {
  match-clients { 2001:db8:81::/48; };
  recursion yes;
  zone "genfic.com" {
        type master;
        file "pri/genfic.com";
<command>        inline-signing yes;
        auto-dnssec maintain;</command>
  };
  zone "1.8.0.0.8.b.d.0.1.0.0.2.ip6.arpa" {
        type master;
        file "pri/genfic.com.inv";
<command>        inline-signing yes;
        auto-dnssec maintain;</command>
  };
};

<command>include "/etc/bind/bind.keys";</command></programlisting>

        <para>Make sure that the named daemon has write access to the zone
        files (both through the SELinux
        <parameter>named_write_masters_zone</parameter> boolean as well as
        regular Linux permissions) as it will save the signed records next to
        the regular file.</para>

        <para>With these changes made, restarting the named daemon enables
        DNSSEC support.</para>
      </section>
    </section>

    <section>
      <title>Using bind</title>

      <para>The bind server is started and managed through its init
      script.</para>

      <programlisting># <command>run_init rc-service named start</command></programlisting>

      <section>
        <title>Validating configurations</title>

        <para>The installed utilities can help troubleshoot configuration
        issues.</para>

        <para>The <command>named-checkconf</command> tool will verify the
        syntax of the <filename>named.conf</filename> file and report any
        issues it finds.</para>

        <para>With <command>named-checkzone</command>, the syntax of the zone
        files can be validated.</para>
      </section>

      <section>
        <title>Checking named results</title>

        <para>A good tool to query name servers (to make sure they function
        correctly) is dig.</para>

        <para>To see if the name server is up and running:</para>

        <programlisting># <command>ping6 -n -c 1 ns.genfic.com</command></programlisting>

        <para>If the host resolves (locally) and replies, then at least the
        local network is working. Now query the name server itself, asking for
        the IP address of mail.genfic.com:</para>

        <programlisting># <command>dig @ns.genfic.com mail.genfic.com AAAA</command></programlisting>

        <para>To get a reverse lookup, use -n -x:</para>

        <programlisting># <command>dig -x 2001:db8:81:22::ae:6b01:e3d8 @ns.genfic.com </command></programlisting>

        <para>If the output of dig is not needed, but just the answer, add in
        "+short".</para>

        <programlisting># <command>dig mail.genfic.com AAAA @ns.genfic.com +short</command>
2001:db8:81:21:0:b0:738:8ad5</programlisting>
      </section>

      <section>
        <title>Sending DNSSEC DS Records to the parent domain</title>

        <para>When the DNS service provides DNSSEC, the Delegation Signer
        information should be uploaded to the parent domain service. This DS
        record will then be stored in the parent zone, and thus get its own
        digital signature so clients can check the validity of the key. To
        push the DS records, generate those using
        <command>dnssec-dsfromkey</command> against the KSK:</para>

        <programlisting># <command>grep key-signing *.key</command>
K1.8.0.0.8.b.d.0.1.0.0.2.ip6.arpa.+008+41569.key:; This is a key-signing key, \
  keyid 41569, for 1.8.0.0.8.b.d.0.1.0.0.2.ip6.arpa.
Kgenfic.com.+008+51397.key:; This is a key-signing key, keyid 51397, for \
  genfic.com
# <command>dnssec-dsfromkey Kgenfic.com.+008+51397.key</command>
genfic.com. IN DS 51397 8 1 B23D4D54B971A2A835A31B2B1AF24AB43E2C8EA2
genfic.com. IN DS 51397 8 2 323F009E2B952F3247DC78BA85AA38A9C798B5FE129A78935CCC4686 \
  C5F02A14</programlisting>

        <para>These records (the first is a SHA1 checksum of the DNSKEY and
        owner information, the second one a SHA256 checksum of the same data)
        can now be submitted to the registrar. Some support an automated way
        to handle this, others still require to send it manually. Just make
        sure it is sent securely - not that the information is private, but if
        the registrar doesn't take proper measures to make sure it is an
        authoritative figure handing over the DS records, then the entire idea
        of a secure DNS falls down.</para>
      </section>

      <section>
        <title>Refreshing DNSSEC Zone Signing Keys</title>

        <para>While creating the keys, <command>dnssec-keygen</command>
        supports timing information to allow for proper roll-over of the zone
        signing keys. This information includes a publication date (when will
        the new key be published in the DNS records, even if the key is not
        used yet), activation date (when will the new key be used to sign
        records), inactivation date and deletion date. When refreshing the
        zone keys, the DS records do not need to be resubmitted (as those are
        made against the key-signing key, not zone-signing key).</para>

        <para>When made available, run <command>rndc loadkeys
        genfic.com</command> to reload the keys for the genfic.com
        domain.</para>

        <para>What if the key signing keys are refreshed? In that case, send
        over the new DS records to the parent domain. It is better to do
        double-signing when refreshing KSK versus using roll-over periods for
        ZSK, as the KSK only signs one record (the DNSKEY one) whereas the ZSK
        signs many more records. Double-signing would increase the amount of
        records immensely in case of the ZSK.</para>
      </section>

      <section>
        <title>Pushing changes</title>

        <para>Changes to BIND can be pushed using the
        <command>nsupdate</command><indexterm>
            <primary>nsupdate</primary>
          </indexterm> application. Make sure the system from which it is run
        has the proper rights in BIND (through the
        <parameter>allow-update</parameter> directive). Once set up though, it
        can be used to create the feed from, for instance, a configuration
        management database.</para>

        <programlisting>$ <command>cat changes.txt</command>
server 2001:db8:81:21::ac:98ad:5fe1 53
update add mail2.internal.genfic.com 3600 AAAA 2001:db8:81:22::50:5e9f:e569
$ <command>nsupdate ./changes.txt</command></programlisting>
      </section>
    </section>

    <section>
      <title>Logging</title>

      <para>In case of DNS services, the following events should probably be
      logged:</para>

      <itemizedlist>
        <listitem>
          <para>queries made against the DNS server (timestamp, source
          address, query itself) and the answers given</para>
        </listitem>

        <listitem>
          <para>modifications made on the configuration (timestamp, source
          address, modification)</para>
        </listitem>
      </itemizedlist>

      <para>Whereas the logging of the queries can be done in local log files,
      modifications need to be sent to a remote location (and might be stored
      locally too) for audit purposes.</para>

      <section>
        <title>Configuring logging</title>

        <para>BIND by default will log through the system logger. This allows
        to store the logging information where needed, perhaps even moving the
        data towards other systems.</para>

        <para>However, BIND does not log queries immediately - it needs to be
        told to do so through the <command>querylog</command> command:</para>

        <programlisting># <command>rndc querylog</command></programlisting>

        <para>Once enabled, queries will appear in the system log like
        so:</para>

        <programlisting>Dec 17 09:15:30 ns named[3721]: client 2001:db8:81:21:0:ac:98ad:5fe1#48818 \
  (mail.genfic.com): view local: query: mail.genfic.com IN AAAA +ED \
  (2001:db8:81:21:0:ac:98ad:5fe1)
Dec 17 09:16:07 ns named[3721]: client 2001:db8:81:21:0:ac:98ad:5fe1#54273 \
  (ns2.genfic.com): view local: query: ns2.genfic.com IN AAAA +ED \
  (2001:db8:81:21:0:ac:98ad:5fe1)</programlisting>

        <para>In the above case, the queries came from the same client (one
        with IPv6 address ending in :5fe1) and the client wanted to know the
        IPv6 addresses of mail.genfic.com and ns2.genfic.com.</para>
      </section>
    </section>
  </section>

  <section>
    <title>Resources</title>

    <para>IP addresses, segmentation and IPv6:</para>

    <itemizedlist>
      <listitem>
        <para><link
        xlink:href="http://www.sans.org/reading_room/whitepapers/hsoffice/design-secure-network-segmentation-approach_1645">Design
        Secure Network Segmentation Approach</link>, article on SANS</para>
      </listitem>

      <listitem>
        <para><link
        xlink:href="http://ipv6.com/articles/general/IPv6-Addressing.htm">IPv6
        Addressing</link> (IPv6.com)</para>
      </listitem>
    </itemizedlist>

    <para>On ISC BIND:</para>

    <itemizedlist>
      <listitem>
        <para><link
        xlink:href="http://en.gentoo-wiki.com/wiki/BIND">BIND</link>
        (Gentoo-wiki.com)</para>
      </listitem>

      <listitem>
        <para><link
        xlink:href="http://www.zytrax.com/books/dns/ch7/xfer.html">DNS BIND
        Zone Transfers and Updates</link> (Zytrax.com); this is part of a
        bigger and interesting reference on BIND9 on Linux/Unix
        systems.</para>
      </listitem>

      <listitem>
        <para><link
        xlink:href="http://www.cyberciti.biz/faq/unix-linux-bind-named-configuring-tsig/">Transaction
        Signatures Configuration</link> (Cyberciti.biz)</para>
      </listitem>

      <listitem>
        <para><link
        xlink:href="http://benchmarks.cisecurity.org/en-us/?route=downloads.show.single.bind.200">CISecurity
        BIND Benchmark</link> (CISecurity.org)</para>
      </listitem>

      <listitem>
        <para><link
        xlink:href="http://backreference.org/2010/11/17/dnssec-verification-with-dig/">DNSSEC
        validation with dig</link> (backreference.org)</para>
      </listitem>

      <listitem>
        <para><link
        xlink:href="https://www.nlnetlabs.nl/publications/dnssec_howto/">DNSSEC
        HOWTO</link> (nlnetlabs.nl)</para>
      </listitem>
    </itemizedlist>
  </section>
</chapter>
